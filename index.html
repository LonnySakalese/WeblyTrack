<!DOCTYPE html>
<!-- D√©claration du type de document HTML5 -->
<html lang="fr">
<!-- Balise d'ouverture HTML, avec la langue du contenu d√©finie sur "fran√ßais" -->

<head>
    <!-- Section d'en-t√™te du document, contenant les m√©tadonn√©es et les liens -->
    <meta charset="UTF-8">
    <!-- D√©clare l'encodage des caract√®res du document comme √©tant UTF-8 -->
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <!-- Configure le viewport pour un affichage optimal sur les appareils mobiles -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- Permet √† l'application web d'√™tre ajout√©e √† l'√©cran d'accueil sur iOS -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Style de la barre de statut sur iOS -->
    <meta name="apple-mobile-web-app-title" content="Warrior">
    <!-- Titre de l'application pour l'√©cran d'accueil iOS -->
    <meta name="theme-color" content="#0A0A0A">
    <!-- Couleur du th√®me pour la barre d'adresse du navigateur sur les mobiles -->
    <meta name="description" content="Suivi d'habitudes - Mentalit√© de champion">
    <!-- Description de l'application pour les moteurs de recherche -->
    <meta name="mobile-web-app-capable" content="yes">
    <!-- Permet √† l'application web d'√™tre ajout√©e √† l'√©cran d'accueil sur Android -->

    <!-- LIENS EXTERNES ET INTERNES -->
    <link rel="manifest" href="manifest.json">
    <!-- Lien vers le fichier manifest pour la PWA (Progressive Web App) -->
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230A0A0A' width='100' height='100' rx='20'/><path d='M 23 74 Q 27 70 31 66 Q 39 58 47 54 Q 55 50 62 39 Q 68 29 74 19' fill='none' stroke='%23F5F5F0' stroke-width='6' stroke-linecap='round'/><path d='M 66 16 L 77 18 L 75 29' fill='none' stroke='%23F5F5F0' stroke-width='6' stroke-linecap='round'/></svg>">
    <!-- Favicon SVG int√©gr√© directement dans le HTML -->
    <link rel="apple-touch-icon" href="favicon.svg">
    <!-- Ic√¥ne pour l'√©cran d'accueil sur les appareils Apple -->
    <title>WARRIOR TRACKER</title>
    <!-- Titre de la page qui s'affiche dans l'onglet du navigateur -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Inclusion de la biblioth√®que Chart.js pour les graphiques -->

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <!-- Inclusion des biblioth√®ques Firebase pour l'authentification et la base de donn√©es -->

    <!-- STYLES CSS -->
    <style>
        /* D√©finition des variables de couleur pour le th√®me de l'application */
        :root {
            --black: #0A0A0A;
            --dark-gray: #141414;
            --charcoal: #1E1E1E;
            --accent: #F5F5F0;
            --accent-dim: #D4D4CF;
            --accent-dark: #A3A39E;
            --steel: #3A3A3A;
            --success: #F5F5F0;
            --warning: #8A8A85;
        }

        /* R√©initialisation des styles de base pour tous les √©l√©ments */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            /* Supprime le surlignage au toucher sur les mobiles */
        }

        /* Style g√©n√©ral du corps de la page */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--black);
            color: white;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            /* Assure la hauteur pleine page sur les navigateurs mobiles */
            padding-bottom: calc(80px + env(safe-area-inset-bottom));
            /* Marge inf√©rieure pour la barre de navigation et les zones de s√©curit√© des iPhones */
            padding-top: env(safe-area-inset-top);
            /* Marge sup√©rieure pour les zones de s√©curit√© */
            -webkit-font-smoothing: antialiased;
            /* Am√©liore le rendu des polices */
            -webkit-overflow-scrolling: touch;
            /* Active le d√©filement fluide sur iOS */
            overscroll-behavior-y: contain;
            /* Emp√™che le d√©filement de "rebondir" en haut et en bas */
        }

        html {
            height: -webkit-fill-available;
        }

        /* En-t√™te de l'application */
        .header {
            background: var(--black);
            padding: 20px 15px;
            text-align: center;
            position: sticky;
            /* L'en-t√™te reste visible lors du d√©filement */
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--steel);
        }

        .header h1 {
            font-size: 1.4rem;
            font-weight: 900;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .header .quote {
            font-size: 0.75rem;
            color: var(--accent-dark);
            font-style: italic;
            margin-top: 5px;
        }

        /* Navigation par date */
        .date-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--dark-gray);
        }

        .date-nav button {
            background: var(--charcoal);
            border: 1px solid var(--steel);
            color: var(--accent);
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .date-nav .current-date {
            font-size: 1rem;
            font-weight: bold;
            color: white;
            min-width: 150px;
            text-align: center;
        }

        /* Conteneur des indicateurs cl√©s de performance (KPI) */
        .kpi-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            /* Grille √† 3 colonnes */
            gap: 10px;
            padding: 15px;
            background: var(--dark-gray);
        }

        .kpi-card {
            background: var(--charcoal);
            border: 1px solid var(--steel);
            border-radius: 10px;
            padding: 12px 8px;
            text-align: center;
        }

        .kpi-card .label {
            font-size: 0.6rem;
            color: var(--accent-dark);
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .kpi-card .value {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--accent);
            margin: 5px 0;
        }

        .kpi-card .sub {
            font-size: 0.55rem;
            color: var(--accent-dark);
        }

        /* Titres de section */
        .section-title {
            background: var(--charcoal);
            color: var(--accent);
            padding: 12px 15px;
            font-size: 0.9rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--steel);
        }

        /* Liste des habitudes */
        .habits-list {
            padding: 0;
        }

        .habit-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: var(--dark-gray);
            border-bottom: 1px solid var(--charcoal);
            gap: 15px;
        }

        .habit-item:active {
            background: var(--charcoal);
            /* Effet visuel au toucher */
        }

        .habit-item.locked {
            opacity: 0.5;
            cursor: not-allowed;
            /* Style pour les jours pass√©s non modifiables */
        }

        .habit-item.locked:active {
            background: var(--dark-gray);
        }

        .habit-checkbox.locked {
            cursor: not-allowed;
        }

        /* Case √† cocher personnalis√©e pour les habitudes */
        .habit-checkbox {
            width: 45px;
            height: 45px;
            border: 2px solid var(--accent-dark);
            border-radius: 50%;
            /* Forme circulaire */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .habit-checkbox.checked {
            background: var(--accent);
            border-color: var(--accent);
            /* Style quand l'habitude est compl√©t√©e */
        }

        .habit-checkbox.checked::after {
            content: '‚úì';
            /* Affiche une coche */
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--black);
        }

        .habit-info {
            flex: 1;
        }

        .habit-name {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 3px;
        }

        .habit-streak {
            font-size: 0.7rem;
            color: var(--accent-dark);
        }

        .habit-progress {
            width: 50px;
            text-align: right;
        }

        .habit-progress .percent {
            font-size: 1rem;
            font-weight: bold;
            color: var(--accent-dim);
        }

        /* Styles pour les graphiques */
        .chart-container {
            padding: 15px;
            background: var(--dark-gray);
        }

        .chart-wrapper {
            background: var(--charcoal);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .chart-title {
            font-size: 0.8rem;
            color: var(--accent);
            text-transform: uppercase;
            margin-bottom: 10px;
            font-weight: bold;
        }

        canvas {
            max-height: 200px;
            /* Limite la hauteur des graphiques */
        }

        /* Barre de navigation inf√©rieure */
        .bottom-nav {
            position: fixed;
            /* La barre reste en bas de l'√©cran */
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            background: var(--black);
            border-top: 1px solid var(--steel);
            z-index: 100;
            padding-bottom: env(safe-area-inset-bottom);
            /* Marge pour les zones de s√©curit√© */
        }

        .nav-item {
            flex: 1;
            padding: 12px 5px;
            text-align: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .nav-item.active {
            background: var(--charcoal);
            /* Style de l'onglet actif */
        }

        .nav-item .icon {
            font-size: 1.3rem;
            margin-bottom: 3px;
        }

        .nav-item .label {
            font-size: 0.6rem;
            color: var(--accent);
            text-transform: uppercase;
        }

        /* Syst√®me de pages/onglets */
        .page {
            display: none;
            /* Les pages sont masqu√©es par d√©faut */
        }

        .page.active {
            display: block;
            /* La page active est affich√©e */
        }

        /* Affichage du rang */
        .rank-display {
            background: var(--charcoal);
            margin: 15px;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--steel);
        }

        .rank-display .rank-title {
            font-size: 0.7rem;
            color: var(--accent-dark);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .rank-display .rank-name {
            font-size: 2rem;
            font-weight: 900;
            color: var(--accent);
            margin: 10px 0;
        }

        .rank-display .rank-progress {
            background: var(--steel);
            border-radius: 10px;
            height: 10px;
            margin-top: 10px;
            overflow: hidden;
        }

        .rank-display .rank-progress-bar {
            height: 100%;
            background: var(--accent);
            border-radius: 10px;
            transition: width 0.5s ease;
            /* Animation de la barre de progression */
        }

        /* Grille des statistiques */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 15px;
        }

        .stat-card {
            background: var(--charcoal);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid var(--steel);
        }

        .stat-card .stat-value {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--accent);
        }

        .stat-card .stat-label {
            font-size: 0.65rem;
            color: var(--accent-dark);
            text-transform: uppercase;
            margin-top: 5px;
        }

        /* Carte de motivation */
        .motivation-card {
            background: var(--charcoal);
            margin: 15px;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid var(--accent);
        }

        .motivation-card .quote-text {
            font-size: 0.9rem;
            font-style: italic;
            color: var(--accent);
            line-height: 1.5;
        }

        .motivation-card .quote-author {
            font-size: 0.75rem;
            color: var(--accent-dark);
            margin-top: 10px;
            font-weight: bold;
        }

        /* Grille de la semaine */
        .weekly-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            /* 7 colonnes pour les jours de la semaine */
            gap: 5px;
            padding: 15px;
        }

        .weekly-day {
            text-align: center;
            padding: 10px 5px;
            background: var(--charcoal);
            border-radius: 8px;
        }

        .weekly-day .day-name {
            font-size: 0.6rem;
            color: var(--accent-dark);
            margin-bottom: 5px;
        }

        .weekly-day .day-score {
            font-size: 1rem;
            font-weight: bold;
            color: var(--accent);
        }

        .weekly-day.today {
            border: 2px solid var(--accent);
            /* Surligne le jour actuel */
        }

        .weekly-day.perfect {
            background: var(--accent);
            /* Style pour un jour parfait (100%) */
        }

        .weekly-day.perfect .day-score {
            color: var(--black);
        }

        .weekly-day.perfect .day-name {
            color: var(--black);
        }

        /* Section des param√®tres */
        .settings-section {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Bouton de r√©initialisation */
        .reset-btn {
            background: var(--steel);
            color: var(--accent);
            border: 1px solid var(--accent-dark);
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            text-align: center;
            transition: all 0.2s ease;
        }

        .reset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 245, 240, 0.1);
        }

        .reset-btn:active {
            transform: scale(0.98);
        }

        /* Bouton de gestion des habitudes */
        .edit-habits-btn {
            background: var(--accent);
            color: var(--black);
            border: 1px solid var(--accent-dark);
        }

        .edit-habits-btn:hover {
            background: var(--accent-dark);
        }

        /* Bouton de notifications */
        .reset-btn#notifBtn {
            background: var(--charcoal);
            color: var(--accent);
        }

        .reset-btn#notifBtn:hover {
            background: var(--steel);
        }

        /* Bouton de suppression de compte */
        .reset-btn#deleteAccountBtn {
            background: #8B0000;
            color: #FFE5E5;
            border: 1px solid #A00000;
            margin-top: 20px;
            border-top: 2px solid var(--steel);
            padding-top: 20px;
        }

        .reset-btn#deleteAccountBtn:hover {
            background: #A00000;
            box-shadow: 0 4px 12px rgba(139, 0, 0, 0.3);
        }

        /* Bouton de validation de journ√©e */
        .validate-day-btn {
            width: calc(100% - 30px);
            margin: 30px 15px 20px 15px;
            padding: 18px;
            background: linear-gradient(135deg, #2ECC71, #27AE60);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: bold;
            letter-spacing: 1px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.3);
            transition: all 0.3s ease;
        }

        .validate-day-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(46, 204, 113, 0.4);
        }

        .validate-day-btn:active {
            transform: translateY(-1px);
        }

        /* Fen√™tre modale (pour l'√©dition des habitudes) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: none;
            /* Cach√©e par d√©faut */
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
            /* Affich√©e quand la classe 'active' est ajout√©e */
        }

        .modal {
            background: var(--charcoal);
            border-radius: 15px;
            padding: 25px;
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--steel);
            animation: scaleIn 0.3s ease-out;
            /* Animation d'apparition */
        }

        .modal h3 {
            color: var(--accent);
            font-size: 1.1rem;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-habit-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding: 10px;
            background: var(--dark-gray);
            border-radius: 8px;
        }

        .modal-habit-item .icon {
            font-size: 1.3rem;
            width: 35px;
            text-align: center;
        }

        .modal-habit-item input {
            flex: 1;
            background: var(--charcoal);
            border: 1px solid var(--steel);
            border-radius: 5px;
            padding: 10px;
            color: var(--accent);
            font-size: 0.9rem;
            font-family: inherit;
        }

        .modal-habit-item input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }

        .modal-btn.cancel {
            background: var(--steel);
            color: var(--accent);
        }

        .modal-btn.save {
            background: var(--accent);
            color: var(--black);
        }

        .modal-btn:active {
            transform: scale(0.95);
        }

        .edit-habits-btn {
            background: var(--charcoal);
            width: 100%;
        }

        /* ANIMATIONS */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes checkPop {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Assignation des animations aux √©l√©ments */
        .header {
            animation: fadeIn 0.5s ease-out;
        }

        .kpi-card {
            animation: scaleIn 0.4s ease-out backwards;
        }

        .kpi-card:nth-child(1) {
            animation-delay: 0.1s;
        }

        .kpi-card:nth-child(2) {
            animation-delay: 0.2s;
        }

        .kpi-card:nth-child(3) {
            animation-delay: 0.3s;
        }

        .habit-item {
            animation: fadeInUp 0.4s ease-out backwards;
        }

        /* D√©lai d'animation pour chaque √©l√©ment de la liste pour un effet d'escalier */
        .habit-item:nth-child(1) {
            animation-delay: 0.05s;
        }

        .habit-item:nth-child(2) {
            animation-delay: 0.1s;
        }

        .habit-item:nth-child(3) {
            animation-delay: 0.15s;
        }

        .habit-item:nth-child(4) {
            animation-delay: 0.2s;
        }

        .habit-item:nth-child(5) {
            animation-delay: 0.25s;
        }

        .habit-item:nth-child(6) {
            animation-delay: 0.3s;
        }

        .habit-item:nth-child(7) {
            animation-delay: 0.35s;
        }

        .habit-item:nth-child(8) {
            animation-delay: 0.4s;
        }

        .habit-item:nth-child(9) {
            animation-delay: 0.45s;
        }

        .habit-item:nth-child(10) {
            animation-delay: 0.5s;
        }

        .habit-checkbox {
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .habit-checkbox.checked {
            animation: checkPop 0.3s ease-out;
        }

        .habit-checkbox:hover {
            transform: scale(1.1);
        }

        .section-title {
            animation: fadeIn 0.4s ease-out;
        }

        .rank-display {
            animation: scaleIn 0.5s ease-out;
        }

        .stat-card {
            animation: fadeInUp 0.4s ease-out backwards;
        }

        .stats-grid .stat-card:nth-child(1) {
            animation-delay: 0.1s;
        }

        .stats-grid .stat-card:nth-child(2) {
            animation-delay: 0.15s;
        }

        .stats-grid .stat-card:nth-child(3) {
            animation-delay: 0.2s;
        }

        .stats-grid .stat-card:nth-child(4) {
            animation-delay: 0.25s;
        }

        .weekly-day {
            animation: scaleIn 0.3s ease-out backwards;
        }

        .weekly-day:nth-child(1) {
            animation-delay: 0.05s;
        }

        .weekly-day:nth-child(2) {
            animation-delay: 0.1s;
        }

        .weekly-day:nth-child(3) {
            animation-delay: 0.15s;
        }

        .weekly-day:nth-child(4) {
            animation-delay: 0.2s;
        }

        .weekly-day:nth-child(5) {
            animation-delay: 0.25s;
        }

        .weekly-day:nth-child(6) {
            animation-delay: 0.3s;
        }

        .weekly-day:nth-child(7) {
            animation-delay: 0.35s;
        }

        .motivation-card {
            animation: fadeInUp 0.5s ease-out;
        }

        .chart-wrapper {
            animation: fadeIn 0.6s ease-out backwards;
        }

        .chart-wrapper:nth-child(1) {
            animation-delay: 0.2s;
        }

        .chart-wrapper:nth-child(2) {
            animation-delay: 0.4s;
        }

        /* Transitions pour une meilleure exp√©rience utilisateur */
        .nav-item {
            transition: all 0.2s ease;
        }

        .nav-item:active {
            transform: scale(0.95);
        }

        .date-nav button {
            transition: all 0.2s ease;
        }

        .date-nav button:active {
            transform: scale(0.9);
        }

        .kpi-card .value {
            transition: all 0.3s ease;
        }

        .page {
            animation: fadeIn 0.3s ease-out;
        }

        /* AUTH PAGE STYLES */
        .auth-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 20px;
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-logo svg {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
        }

        .auth-logo h1 {
            font-size: 1.8rem;
            color: var(--accent);
            font-weight: 900;
            letter-spacing: 3px;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            background: var(--charcoal);
            border: 1px solid var(--steel);
            color: var(--accent);
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .auth-tab.active {
            background: var(--accent);
            color: var(--black);
        }

        .auth-tab:active {
            transform: scale(0.98);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .auth-form input {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            background: var(--charcoal);
            border: 1px solid var(--steel);
            border-radius: 8px;
            color: var(--accent);
            font-size: 1rem;
            font-family: inherit;
        }

        .auth-form input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .auth-btn {
            width: 100%;
            padding: 15px;
            background: var(--accent);
            color: var(--black);
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .auth-btn:active {
            transform: scale(0.98);
        }

        .auth-error {
            color: #FF6B6B;
            font-size: 0.85rem;
            margin-top: 10px;
            text-align: center;
            padding: 10px;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 5px;
            display: none;
        }

        .forgot-password-link {
            display: block;
            margin-top: 15px;
            text-align: center;
            color: var(--accent);
            font-size: 0.9rem;
            text-decoration: none;
            transition: opacity 0.2s;
        }

        .forgot-password-link:hover {
            opacity: 0.8;
            text-decoration: underline;
        }

        .auth-error.show {
            display: block;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 15px;
            padding: 8px 15px;
            background: var(--charcoal);
            border: 1px solid var(--steel);
            color: var(--accent);
            border-radius: 5px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            display: none;
        }

        .logout-btn:active {
            transform: scale(0.95);
        }

        .loading-spinner {
            text-align: center;
            padding: 50px;
            font-size: 2rem;
            animation: pulse 1.5s infinite;
        }

        /* Migration Modal Styles */
        .migration-preview {
            background: var(--dark-gray);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .migration-stat {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--steel);
        }

        .migration-stat:last-child {
            border-bottom: none;
        }

        .migration-stat span {
            color: var(--accent-dim);
        }

        .migration-stat strong {
            color: var(--accent);
        }

        /* HABIT MANAGEMENT STYLES */
        .modal-large {
            max-width: 600px;
        }

        .habits-management-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .habit-management-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--dark-gray);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .habit-management-item.editing {
            border-color: var(--accent);
            background: var(--charcoal);
        }

        .habit-color-indicator {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid var(--steel);
            flex-shrink: 0;
        }

        .habit-icon-display {
            font-size: 1.5rem;
            width: 40px;
            text-align: center;
            flex-shrink: 0;
        }

        .habit-name-input {
            flex: 1;
            background: var(--charcoal);
            border: 1px solid var(--steel);
            border-radius: 5px;
            padding: 8px 12px;
            color: var(--accent);
            font-size: 0.9rem;
            font-family: inherit;
        }

        .habit-name-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .habit-name-input:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .habit-actions {
            display: flex;
            gap: 5px;
        }

        .habit-action-btn {
            padding: 6px 10px;
            border: 1px solid var(--steel);
            background: var(--charcoal);
            color: var(--accent);
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .habit-action-btn:hover {
            background: var(--steel);
        }

        .habit-action-btn.delete {
            background: rgba(138, 58, 58, 0.3);
            border-color: #8A3A3A;
            color: #FF6B6B;
        }

        .habit-action-btn.delete:hover {
            background: rgba(138, 58, 58, 0.5);
        }

        .add-habit-section {
            background: var(--charcoal);
            border: 2px dashed var(--steel);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .add-habit-section.collapsed {
            padding: 0;
        }

        .add-habit-toggle {
            width: 100%;
            padding: 15px;
            background: var(--charcoal);
            border: 2px dashed var(--steel);
            color: var(--accent);
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.95rem;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .add-habit-toggle:hover {
            background: var(--steel);
        }

        .add-habit-form {
            display: none;
        }

        .add-habit-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: var(--accent-dim);
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 1px;
        }

        .form-group input[type="text"] {
            width: 100%;
            padding: 12px;
            background: var(--dark-gray);
            border: 1px solid var(--steel);
            border-radius: 8px;
            color: var(--accent);
            font-size: 1rem;
            font-family: inherit;
        }

        .form-group input[type="text"]:focus {
            outline: none;
            border-color: var(--accent);
        }

        .icon-picker {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .icon-option {
            font-size: 1.8rem;
            padding: 12px;
            text-align: center;
            background: var(--dark-gray);
            border: 2px solid var(--steel);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .icon-option:hover {
            transform: scale(1.1);
            background: var(--charcoal);
        }

        .icon-option.selected {
            border-color: var(--accent);
            background: var(--accent);
            transform: scale(1.15);
        }

        .color-picker-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .color-option {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 8px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: white;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            transform: scale(1.15);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .form-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .form-btn.cancel {
            background: var(--steel);
            color: var(--accent);
        }

        .form-btn.save {
            background: var(--accent);
            color: var(--black);
        }

        .form-btn:active {
            transform: scale(0.98);
        }

        .move-buttons {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .move-btn {
            padding: 4px 8px;
            background: var(--charcoal);
            border: 1px solid var(--steel);
            color: var(--accent-dim);
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.7rem;
        }

        .move-btn:hover {
            background: var(--steel);
            color: var(--accent);
        }

        .move-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <!-- Page d'authentification (affich√©e si non connect√©) -->
    <div id="page-auth" class="page">
        <div class="auth-container">
            <div class="auth-logo">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                    <rect fill="#0A0A0A" width="100" height="100" rx="20"/>
                    <path d="M 23 74 Q 27 70 31 66 Q 39 58 47 54 Q 55 50 62 39 Q 68 29 74 19" fill="none" stroke="#F5F5F0" stroke-width="6" stroke-linecap="round"/>
                    <path d="M 66 16 L 77 18 L 75 29" fill="none" stroke="#F5F5F0" stroke-width="6" stroke-linecap="round"/>
                </svg>
                <h1>WARRIOR TRACKER</h1>
            </div>

            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login')">CONNEXION</button>
                <button class="auth-tab" onclick="showAuthTab('signup')">INSCRIPTION</button>
            </div>

            <!-- Formulaire de connexion -->
            <div id="auth-login" class="auth-form active">
                <input type="email" id="login-email" placeholder="Email" autocomplete="email">
                <input type="password" id="login-password" placeholder="Mot de passe" autocomplete="current-password">
                <button class="auth-btn" onclick="handleLogin()">Se connecter</button>
                <div class="auth-error" id="login-error"></div>
                <a href="#" class="forgot-password-link" onclick="handleForgotPassword(); return false;">Mot de passe oubli√© ?</a>
            </div>

            <!-- Formulaire d'inscription -->
            <div id="auth-signup" class="auth-form">
                <input type="email" id="signup-email" placeholder="Email" autocomplete="email">
                <input type="password" id="signup-password" placeholder="Mot de passe (min 6 caract√®res)" autocomplete="new-password">
                <input type="password" id="signup-confirm" placeholder="Confirmer le mot de passe" autocomplete="new-password">
                <button class="auth-btn" onclick="handleSignup()">S'inscrire</button>
                <div class="auth-error" id="signup-error"></div>
            </div>
        </div>
    </div>

    <!-- En-t√™te principal de l'application -->
    <div class="header">
        <h1>‚öîÔ∏è WARRIOR TRACKER</h1>
        <div class="quote">"STAY HARD" - David Goggins</div>
        <button class="logout-btn" id="logoutBtn" onclick="handleLogout()">üö™ D√©connexion</button>
    </div>

    <!-- Page "Aujourd'hui" : affiche les habitudes du jour -->
    <div id="page-today" class="page active">
        <!-- Navigation pour changer de date -->
        <div class="date-nav">
            <button onclick="changeDate(-1)">‚óÄ</button>
            <div class="current-date" id="currentDate"></div>
            <button onclick="changeDate(1)">‚ñ∂</button>
        </div>

        <!-- Indicateurs cl√©s de performance (KPIs) -->
        <div class="kpi-container">
            <div class="kpi-card">
                <div class="label">Score</div>
                <div class="value" id="dailyScore">0%</div>
                <div class="sub">Aujourd'hui</div>
            </div>
            <div class="kpi-card">
                <div class="label">Streak</div>
                <div class="value" id="currentStreak">0</div>
                <div class="sub">Jours</div>
            </div>
            <div class="kpi-card">
                <div class="label">Perfect</div>
                <div class="value" id="perfectDays">0</div>
                <div class="sub">Jours 100%</div>
            </div>
        </div>

        <!-- Titre de la section des habitudes -->
        <div class="section-title">
            <span>üéØ MISSIONS DU JOUR</span>
            <span id="completedCount">0/10</span>
        </div>

        <!-- Liste des habitudes (g√©n√©r√©e par JavaScript) -->
        <div class="habits-list" id="habitsList"></div>

        <!-- Bouton pour valider la journ√©e -->
        <button id="validateDayBtn" class="validate-day-btn" onclick="showValidateDayModal()" style="display: none;">
            ‚úÖ VALIDER LA JOURN√âE
        </button>
    </div>

    <!-- Page "Stats" : affiche les statistiques et graphiques -->
    <div id="page-stats" class="page">
        <!-- Affichage du rang de l'utilisateur -->
        <div class="rank-display">
            <div class="rank-title">Ton Rang Actuel</div>
            <div class="rank-name" id="rankName">RECRUIT</div>
            <div class="rank-progress">
                <div class="rank-progress-bar" id="rankProgress" style="width: 0%"></div>
            </div>
        </div>

        <!-- Grille de performance de la semaine -->
        <div class="section-title">üìä CETTE SEMAINE</div>
        <div class="weekly-grid" id="weeklyGrid"></div>

        <!-- Section des graphiques de progression -->
        <div class="section-title">üìà PROGRESSION</div>
        <div class="chart-container">
            <div class="chart-wrapper">
                <div class="chart-title">Score des 7 derniers jours</div>
                <canvas id="weeklyChart"></canvas>
            </div>
            <div class="chart-wrapper">
                <div class="chart-title">Performance par habitude</div>
                <canvas id="habitsChart"></canvas>
            </div>
        </div>

        <!-- Grille des statistiques g√©n√©rales -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="monthScore">0%</div>
                <div class="stat-label">Score du mois</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="bestStreak">0</div>
                <div class="stat-label">Meilleure s√©rie</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalWins">0</div>
                <div class="stat-label">Victoires totales</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgScore">0%</div>
                <div class="stat-label">Moyenne globale</div>
            </div>
        </div>
    </div>

    <!-- Page "Motivation" : citations, r√®gles et informations -->
    <div id="page-motivation" class="page">
        <div class="section-title">üî• MENTAL DE CHAMPION</div>
        <div class="motivation-card">
            <div class="quote-text" id="dailyQuote">"I don't count my sit-ups. I only start counting when it hurts."
            </div>
            <div class="quote-author" id="quoteAuthor">- Muhammad Ali</div>
        </div>

        <!-- Explication du syst√®me de rangs -->
        <div class="section-title">üèÜ SYST√àME DE RANG</div>
        <div style="padding: 15px;">
            <div class="stat-card" style="margin-bottom: 10px; border-color: #5A5A55;">
                <div style="color: #5A5A55; font-weight: bold;">RECRUIT</div>
                <div style="color: #5A5A55; font-size: 0.7rem;">0-30%</div>
            </div>
            <div class="stat-card" style="margin-bottom: 10px; border-color: #7A7A75;">
                <div style="color: #7A7A75; font-weight: bold;">SOLDIER</div>
                <div style="color: #7A7A75; font-size: 0.7rem;">31-50%</div>
            </div>
            <div class="stat-card" style="margin-bottom: 10px; border-color: #A3A39E;">
                <div style="color: #A3A39E; font-weight: bold;">WARRIOR</div>
                <div style="color: #A3A39E; font-size: 0.7rem;">51-70%</div>
            </div>
            <div class="stat-card" style="margin-bottom: 10px; border-color: #D4D4CF;">
                <div style="color: #D4D4CF; font-weight: bold;">ELITE</div>
                <div style="color: #D4D4CF; font-size: 0.7rem;">71-85%</div>
            </div>
            <div class="stat-card" style="border-color: var(--accent); background: var(--accent);">
                <div style="color: var(--black); font-weight: bold;">LEGEND</div>
                <div style="color: var(--black); font-size: 0.7rem;">86-100%</div>
            </div>
        </div>

        <!-- Section des param√®tres -->
        <div class="section-title">‚öôÔ∏è PARAM√àTRES</div>
        <div class="settings-section">
            <button class="reset-btn edit-habits-btn" onclick="openManageHabitsModal()">‚öôÔ∏è G√âRER LES HABITUDES</button>

            <div class="notif-time-container">
                <label for="notifTime" style="color: var(--accent); font-size: 0.9rem; margin-bottom: 8px; display: block;">‚è∞ Heure de rappel :</label>
                <input type="time" id="notifTime" value="21:00" onchange="updateNotificationTime()"
                    style="width: 100%; padding: 12px; background: var(--charcoal); color: var(--accent);
                    border: 1px solid var(--accent-dark); border-radius: 8px; font-size: 1rem; text-align: center;">
            </div>

            <button id="notifBtn" class="reset-btn" onclick="toggleNotifications()">üîï Notifications OFF</button>
            <button class="reset-btn" onclick="resetAllData()">üóëÔ∏è R√âINITIALISER TOUTES LES DONN√âES</button>
            <button id="deleteAccountBtn" class="reset-btn" style="display: none;" onclick="handleDeleteAccount()">‚ùå SUPPRIMER MON COMPTE</button>
        </div>
    </div>

    <!-- Fen√™tre modale pour la gestion compl√®te des habitudes -->
    <div class="modal-overlay" id="manageHabitsModal">
        <div class="modal modal-large">
            <h3>‚öôÔ∏è G√âRER LES HABITUDES</h3>

            <!-- Section pour ajouter une nouvelle habitude -->
            <div class="add-habit-section collapsed" id="addHabitSection">
                <button class="add-habit-toggle" onclick="toggleAddHabitForm()">
                    ‚ûï Ajouter une habitude
                </button>
                <div class="add-habit-form" id="addHabitForm">
                    <div class="form-group">
                        <label>Nom de l'habitude</label>
                        <input type="text" id="newHabitName" placeholder="Ex: M√âDITATION" maxlength="50">
                    </div>

                    <div class="form-group">
                        <label>Ic√¥ne</label>
                        <div class="icon-picker" id="iconPicker">
                            <!-- Ic√¥nes populaires pour habitudes -->
                            <div class="icon-option" data-icon="üßò">üßò</div>
                            <div class="icon-option" data-icon="üèÉ">üèÉ</div>
                            <div class="icon-option" data-icon="üí™">üí™</div>
                            <div class="icon-option" data-icon="üéØ">üéØ</div>
                            <div class="icon-option" data-icon="üìñ">üìñ</div>
                            <div class="icon-option" data-icon="‚úçÔ∏è">‚úçÔ∏è</div>
                            <div class="icon-option" data-icon="üé®">üé®</div>
                            <div class="icon-option" data-icon="üéµ">üéµ</div>
                            <div class="icon-option" data-icon="üß†">üß†</div>
                            <div class="icon-option" data-icon="‚ù§Ô∏è">‚ù§Ô∏è</div>
                            <div class="icon-option" data-icon="üå±">üå±</div>
                            <div class="icon-option" data-icon="‚òÄÔ∏è">‚òÄÔ∏è</div>
                            <div class="icon-option" data-icon="üåô">üåô</div>
                            <div class="icon-option" data-icon="‚≠ê">‚≠ê</div>
                            <div class="icon-option" data-icon="üî•">üî•</div>
                            <div class="icon-option" data-icon="üíé">üíé</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Couleur</label>
                        <div class="color-picker-grid" id="colorPicker">
                            <div class="color-option" data-color="#F5F5F0" style="background: #F5F5F0;"></div>
                            <div class="color-option" data-color="#87CEEB" style="background: #87CEEB;"></div>
                            <div class="color-option" data-color="#90EE90" style="background: #90EE90;"></div>
                            <div class="color-option" data-color="#FFD700" style="background: #FFD700;"></div>
                            <div class="color-option" data-color="#FF6B6B" style="background: #FF6B6B;"></div>
                            <div class="color-option" data-color="#9370DB" style="background: #9370DB;"></div>
                            <div class="color-option" data-color="#FF69B4" style="background: #FF69B4;"></div>
                            <div class="color-option" data-color="#FFA500" style="background: #FFA500;"></div>
                            <div class="color-option" data-color="#4682B4" style="background: #4682B4;"></div>
                            <div class="color-option" data-color="#32CD32" style="background: #32CD32;"></div>
                            <div class="color-option" data-color="#FF4500" style="background: #FF4500;"></div>
                            <div class="color-option" data-color="#8B4513" style="background: #8B4513;"></div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button class="form-btn cancel" onclick="cancelAddHabit()">Annuler</button>
                        <button class="form-btn save" onclick="saveNewHabit()">Ajouter</button>
                    </div>
                </div>
            </div>

            <!-- Liste des habitudes existantes -->
            <div class="habits-management-list" id="habitsManagementList">
                <!-- Rempli dynamiquement par JavaScript -->
            </div>

            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeManageHabitsModal()">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Modal de migration localStorage ‚Üí Firestore -->
    <div class="modal-overlay" id="migrationModal">
        <div class="modal">
            <h3>üîÑ MIGRATION DES DONN√âES</h3>
            <p style="color: var(--accent-dim); text-align: center; margin-bottom: 15px;">
                Nous avons d√©tect√© des donn√©es existantes sur cet appareil.<br>
                Veux-tu les transf√©rer vers ton nouveau compte ?
            </p>
            <div class="migration-preview" id="migrationPreview">
                <!-- Aper√ßu des donn√©es √† migrer (rempli dynamiquement) -->
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="skipMigration()">Ignorer</button>
                <button class="modal-btn save" onclick="performMigration()">Migrer</button>
            </div>
        </div>
    </div>

    <!-- Modal de validation de journ√©e -->
    <div class="modal-overlay" id="validateDayModal">
        <div class="modal">
            <h3>‚úÖ VALIDER LA JOURN√âE</h3>
            <p style="color: var(--accent); text-align: center; margin: 20px 0; font-size: 1.1rem;">
                Es-tu s√ªr de vouloir valider ta journ√©e ?
            </p>
            <p style="color: var(--accent-dim); text-align: center; margin-bottom: 20px; font-size: 0.9rem;">
                Une fois valid√©e, tu ne pourras plus modifier tes habitudes d'aujourd'hui.
            </p>

            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button class="modal-btn cancel" onclick="closeValidateDayModal()">Annuler</button>
                <button class="modal-btn save" onclick="confirmValidateDay()">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- Barre de navigation inf√©rieure fixe -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="showPage('today', event)">
            <div class="icon">‚öîÔ∏è</div>
            <div class="label">Missions</div>
        </div>
        <div class="nav-item" onclick="showPage('stats', event)">
            <div class="icon">üìä</div>
            <div class="label">Stats</div>
        </div>
        <div class="nav-item" onclick="showPage('motivation', event)">
            <div class="icon">üî•</div>
            <div class="label">Mindset</div>
        </div>
    </div>

    <!-- SCRIPT JAVASCRIPT -->
    <script>
        // --- CONFIGURATION INITIALE ---

        // ============================================================
        // FIREBASE CONFIGURATION
        // ============================================================
        // IMPORTANT : Remplacez ces valeurs par votre propre configuration Firebase
        // Obtenez ces valeurs depuis Firebase Console > Project Settings > Your Apps
        const firebaseConfig = {
            apiKey: "AIzaSyAS0RofOjkTjaDjYhlLc1wISqCgozDOjNY",
            authDomain: "warrior-habit-tracker.firebaseapp.com",
            projectId: "warrior-habit-tracker",
            storageBucket: "warrior-habit-tracker.firebasestorage.app",
            messagingSenderId: "986537173596",
            appId: "1:986537173596:web:1ba2b4ec5e8991def47c99"
        };

        // Initialiser Firebase uniquement si la config est valide
        let auth, db;
        const isFirebaseConfigured = firebaseConfig.apiKey !== "VOTRE_API_KEY";

        if (isFirebaseConfigured && typeof firebase !== 'undefined') {
            try {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();

                // Activer la persistance offline
                db.enablePersistence()
                    .catch((err) => {
                        console.warn('Persistance offline non disponible:', err);
                    });

                console.log('‚úÖ Firebase initialis√© avec succ√®s');
            } catch (error) {
                console.error('‚ùå Erreur initialisation Firebase:', error);
            }
        } else {
            console.warn('‚ö†Ô∏è Firebase non configur√© - mode localStorage uniquement');
        }

        // State Management Global
        const appState = {
            currentUser: null,
            isOnline: navigator.onLine,
            isFirebaseMode: isFirebaseConfigured
        };

        // Donn√©es initiales des habitudes
        const habits = [
            { id: 'coldshower', name: 'DOUCHE FROIDE', icon: 'üßä' },
            { id: 'reading', name: 'LECTURE (30 min)', icon: 'üìö' },
            { id: 'nutrition', name: 'NUTRITION CLEAN', icon: 'ü•ó' },
            { id: 'sleep', name: 'SOMMEIL 8H+ (couch√© avant 22h)', icon: 'üò¥' },
            { id: 'hydration', name: 'HYDRATATION 2L+', icon: 'üíß' },
            { id: 'wakeup', name: 'R√âVEIL 5H-6H', icon: '‚è∞' }
        ];

        // Collection de citations de motivation
        const quotes = [
            { text: "Je ne compte pas mes abdos. Je commence √† compter seulement quand √ßa fait mal.", author: "Muhammad Ali" },
            { text: "La douleur que tu ressens aujourd'hui sera la force que tu ressentiras demain.", author: "Arnold Schwarzenegger" },
            { text: "Je ne suis pas le plus talentueux, ni le plus dou√©... mais personne ne travaillera plus dur que moi.", author: "Cristiano Ronaldo" },
            { text: "Qui va porter les bateaux ?!", author: "David Goggins" },
            { text: "Souffre maintenant et vis le reste de ta vie comme un champion.", author: "Muhammad Ali" },
            { text: "Quand tu penses avoir termin√©, tu n'es qu'√† 40% de ta capacit√©.", author: "David Goggins" },
            { text: "La seule personne que tu es destin√© √† devenir est celle que tu d√©cides d'√™tre.", author: "Ralph Waldo Emerson" },
            { text: "Le travail acharn√© bat le talent quand le talent ne travaille pas dur.", author: "Tim Notke" }
        ];

        // ============================================================
        // AUTHENTICATION FUNCTIONS
        // ============================================================

        // Basculer entre les onglets de connexion et d'inscription
        function showAuthTab(tab) {
            // G√©rer les onglets
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));

            if (tab === 'login') {
                document.querySelector('.auth-tab:first-child').classList.add('active');
                document.getElementById('auth-login').classList.add('active');
            } else {
                document.querySelector('.auth-tab:last-child').classList.add('active');
                document.getElementById('auth-signup').classList.add('active');
            }
        }

        // G√©rer l'inscription
        async function handleSignup() {
            if (!isFirebaseConfigured) {
                alert('‚ö†Ô∏è Firebase n\'est pas configur√©. Consultez la documentation pour configurer Firebase.');
                return;
            }

            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;
            const confirm = document.getElementById('signup-confirm').value;
            const errorEl = document.getElementById('signup-error');

            errorEl.textContent = '';
            errorEl.classList.remove('show');

            // Validations
            if (!email || !password || !confirm) {
                errorEl.textContent = 'Tous les champs sont requis';
                errorEl.classList.add('show');
                return;
            }

            if (password !== confirm) {
                errorEl.textContent = 'Les mots de passe ne correspondent pas';
                errorEl.classList.add('show');
                return;
            }

            if (password.length < 6) {
                errorEl.textContent = 'Le mot de passe doit contenir au moins 6 caract√®res';
                errorEl.classList.add('show');
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                console.log('‚úÖ Compte cr√©√©:', userCredential.user.uid);

                // Cr√©er le profil utilisateur dans Firestore
                await createUserProfile(userCredential.user);

                // V√©rifier si migration n√©cessaire
                checkLocalStorageMigration(userCredential.user);

            } catch (error) {
                console.error('‚ùå Erreur inscription:', error);
                errorEl.textContent = getAuthErrorMessage(error.code);
                errorEl.classList.add('show');
            }
        }

        // G√©rer la connexion
        async function handleLogin() {
            if (!isFirebaseConfigured) {
                alert('‚ö†Ô∏è Firebase n\'est pas configur√©. Consultez la documentation pour configurer Firebase.');
                return;
            }

            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');

            errorEl.textContent = '';
            errorEl.classList.remove('show');

            if (!email || !password) {
                errorEl.textContent = 'Email et mot de passe requis';
                errorEl.classList.add('show');
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
                console.log('‚úÖ Connexion r√©ussie');
            } catch (error) {
                console.error('‚ùå Erreur connexion:', error);
                errorEl.textContent = getAuthErrorMessage(error.code);
                errorEl.classList.add('show');
            }
        }

        // G√©rer la d√©connexion
        async function handleLogout() {
            if (!isFirebaseConfigured) return;

            if (confirm('Veux-tu vraiment te d√©connecter ?')) {
                try {
                    await auth.signOut();
                    console.log('‚úÖ D√©connexion r√©ussie');
                } catch (error) {
                    console.error('‚ùå Erreur d√©connexion:', error);
                    alert('Erreur lors de la d√©connexion');
                }
            }
        }

        // R√©initialisation du mot de passe
        async function handleForgotPassword() {
            if (!isFirebaseConfigured) return;

            const email = document.getElementById('login-email').value.trim();

            if (!email) {
                alert('‚ö†Ô∏è Entre ton email pour r√©initialiser ton mot de passe');
                return;
            }

            if (confirm(`üìß Envoyer un email de r√©initialisation √† ${email} ?`)) {
                try {
                    await auth.sendPasswordResetEmail(email);
                    alert('‚úÖ Email de r√©initialisation envoy√© ! V√©rifie ta bo√Æte mail (et les spams).');
                    console.log('‚úÖ Email de r√©initialisation envoy√© √†:', email);
                } catch (error) {
                    console.error('‚ùå Erreur r√©initialisation:', error);
                    const errorMessage = getAuthErrorMessage(error.code);
                    alert('‚ùå ' + errorMessage);
                }
            }
        }

        // Suppression du compte utilisateur
        async function handleDeleteAccount() {
            if (!isFirebaseConfigured) return;

            const user = auth.currentUser;
            if (!user) {
                alert('‚ùå Tu dois √™tre connect√© pour supprimer ton compte');
                return;
            }

            // Triple confirmation pour √©viter les suppressions accidentelles
            if (!confirm('‚ö†Ô∏è ES-TU S√õR de vouloir SUPPRIMER ton compte ?\n\n‚ö†Ô∏è ATTENTION : Cette action est IRR√âVERSIBLE !\n\n- Toutes tes donn√©es seront SUPPRIM√âES\n- Ton historique sera PERDU\n- Tes habitudes seront EFFAC√âES\n\nTape "SUPPRIMER" pour confirmer')) {
                return;
            }

            const confirmation = prompt('‚ö†Ô∏è DERNI√àRE CHANCE !\n\nTape exactement "SUPPRIMER" (en majuscules) pour confirmer la suppression d√©finitive de ton compte :');

            if (confirmation !== 'SUPPRIMER') {
                alert('‚ùå Suppression annul√©e. Ton compte est en s√©curit√©.');
                return;
            }

            try {
                const userId = user.uid;

                // Supprimer toutes les donn√©es Firestore de l'utilisateur
                const batch = db.batch();

                // Supprimer les habitudes
                const habitsSnapshot = await db.collection('users').doc(userId).collection('habits').get();
                habitsSnapshot.forEach(doc => batch.delete(doc.ref));

                // Supprimer les completions
                const completionsSnapshot = await db.collection('users').doc(userId).collection('completions').get();
                completionsSnapshot.forEach(doc => batch.delete(doc.ref));

                // Supprimer les stats
                const statsSnapshot = await db.collection('users').doc(userId).collection('stats').get();
                statsSnapshot.forEach(doc => batch.delete(doc.ref));

                // Supprimer le document utilisateur
                batch.delete(db.collection('users').doc(userId));

                // Commit les suppressions
                await batch.commit();
                console.log('‚úÖ Donn√©es Firestore supprim√©es');

                // Supprimer le compte Firebase Auth
                await user.delete();
                console.log('‚úÖ Compte utilisateur supprim√©');

                // Nettoyer le localStorage
                localStorage.removeItem('warriorTracker');

                alert('‚úÖ Ton compte a √©t√© supprim√© d√©finitivement.\n\nAu revoir, WARRIOR. On esp√®re te revoir ! üí™');

            } catch (error) {
                console.error('‚ùå Erreur suppression compte:', error);

                if (error.code === 'auth/requires-recent-login') {
                    alert('‚ùå Pour des raisons de s√©curit√©, tu dois te reconnecter avant de supprimer ton compte.\n\nD√©connecte-toi puis reconnecte-toi, et r√©essaie.');
                } else {
                    alert('‚ùå Erreur lors de la suppression du compte : ' + error.message);
                }
            }
        }

        // Traduire les codes d'erreur Firebase en fran√ßais
        function getAuthErrorMessage(errorCode) {
            const messages = {
                'auth/email-already-in-use': 'Cet email est d√©j√† utilis√©',
                'auth/invalid-email': 'Email invalide',
                'auth/weak-password': 'Mot de passe trop faible',
                'auth/user-not-found': 'Utilisateur non trouv√©',
                'auth/wrong-password': 'Mot de passe incorrect',
                'auth/too-many-requests': 'Trop de tentatives. R√©essaie plus tard.',
                'auth/network-request-failed': 'Erreur r√©seau. V√©rifie ta connexion.'
            };
            return messages[errorCode] || 'Erreur d\'authentification : ' + errorCode;
        }

        // Cr√©er le profil utilisateur dans Firestore
        async function createUserProfile(user) {
            const userRef = db.collection('users').doc(user.uid);

            await userRef.set({
                email: user.email,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastLogin: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Cr√©er les habitudes par d√©faut (bas√©es sur le tableau habits)
            const batch = db.batch();
            habits.forEach((habit, index) => {
                const habitRef = userRef.collection('habits').doc(habit.id);
                batch.set(habitRef, {
                    name: habit.name,
                    icon: habit.icon,
                    color: '#F5F5F0', // Couleur par d√©faut
                    order: index,
                    isActive: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            });

            await batch.commit();
            console.log('‚úÖ Profil utilisateur cr√©√© avec habitudes par d√©faut');
        }

        // Auth State Listener sera g√©r√© dans DOMContentLoaded

        // V√©rifier si migration localStorage n√©cessaire
        function checkLocalStorageMigration(user) {
            const localData = localStorage.getItem('warriorTracker');

            if (localData) {
                const data = JSON.parse(localData);
                const daysCount = Object.keys(data.days || {}).length;

                if (daysCount > 0) {
                    showMigrationModal(data, user);
                }
            }
        }

        // Afficher la modal de migration
        function showMigrationModal(localData, user) {
            const modal = document.getElementById('migrationModal');
            const preview = document.getElementById('migrationPreview');

            const daysCount = Object.keys(localData.days || {}).length;

            // Calculer les jours parfaits
            let perfectDays = 0;
            Object.values(localData.days || {}).forEach(day => {
                const completed = Object.values(day).filter(Boolean).length;
                if (completed === habits.length) perfectDays++;
            });

            preview.innerHTML = `
                <div class="migration-stat">
                    <span>Jours enregistr√©s</span>
                    <strong>${daysCount}</strong>
                </div>
                <div class="migration-stat">
                    <span>Jours parfaits</span>
                    <strong>${perfectDays}</strong>
                </div>
                <div class="migration-stat">
                    <span>Meilleure s√©rie</span>
                    <strong>${localData.stats?.bestStreak || 0}</strong>
                </div>
            `;

            modal.classList.add('active');

            // Stocker temporairement pour la migration
            window.pendingMigration = { localData, user };
        }

        // Effectuer la migration localStorage ‚Üí Firestore
        async function performMigration() {
            const { localData, user } = window.pendingMigration;

            try {
                console.log('üîÑ D√©but de la migration...');

                // Migration des completions
                let batch = db.batch();
                let batchCount = 0;

                for (const [dateKey, dayData] of Object.entries(localData.days || {})) {
                    for (const [habitId, completed] of Object.entries(dayData)) {
                        if (completed) {
                            const docId = `${dateKey}-${habitId}`;
                            const completionRef = db.collection('users').doc(user.uid)
                                .collection('completions').doc(docId);

                            batch.set(completionRef, {
                                date: dateKey,
                                habitId: habitId,
                                completed: true,
                                completedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });

                            batchCount++;

                            // Firestore limite √† 500 op√©rations par batch
                            if (batchCount >= 400) {
                                await batch.commit();
                                console.log(`‚úÖ Migr√© ${batchCount} completions`);
                                batch = db.batch(); // Cr√©er un nouveau batch
                                batchCount = 0;
                            }
                        }
                    }
                }

                if (batchCount > 0) {
                    await batch.commit();
                    console.log(`‚úÖ Migr√© ${batchCount} completions`);
                }

                // Migration des stats
                const statsRef = db.collection('users').doc(user.uid).collection('stats').doc('global');
                await statsRef.set({
                    bestStreak: localData.stats?.bestStreak || 0,
                    totalWins: 0,
                    perfectDaysCount: 0,
                    lastCalculated: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Migration des noms personnalis√©s
                if (localData.customHabitNames) {
                    const habitBatch = db.batch();
                    for (const [habitId, customName] of Object.entries(localData.customHabitNames)) {
                        const habitRef = db.collection('users').doc(user.uid)
                            .collection('habits').doc(habitId);
                        habitBatch.update(habitRef, { name: customName });
                    }
                    await habitBatch.commit();
                    console.log('‚úÖ Noms personnalis√©s migr√©s');
                }

                // Supprimer les donn√©es locales apr√®s migration r√©ussie
                localStorage.removeItem('warriorTracker');

                closeMigrationModal();
                alert('‚úÖ Migration r√©ussie ! Toutes tes donn√©es ont √©t√© transf√©r√©es.');
                console.log('‚úÖ Migration compl√®te');

            } catch (error) {
                console.error('‚ùå Erreur de migration:', error);
                alert('‚ùå Erreur lors de la migration. Tes donn√©es locales sont conserv√©es.');
            }
        }

        // Ignorer la migration
        function skipMigration() {
            closeMigrationModal();

            // Demander si on veut supprimer les donn√©es locales
            if (confirm('Veux-tu supprimer les donn√©es locales ?')) {
                localStorage.removeItem('warriorTracker');
            }
        }

        // Fermer la modal de migration
        function closeMigrationModal() {
            document.getElementById('migrationModal').classList.remove('active');
            window.pendingMigration = null;
        }

        // --- GESTION DE L'√âTAT ---
        let currentDate = new Date(); // La date actuellement affich√©e, initialis√©e √† aujourd'hui
        let weeklyChart, habitsChart; // Variables pour stocker les instances des graphiques

        // V√©rifie si une date est aujourd'hui
        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        // D√©termine si on peut modifier les habitudes pour une date donn√©e (seulement aujourd'hui et non valid√©)
        function canEditDate(date) {
            // Ne peut pas √©diter si ce n'est pas aujourd'hui
            if (!isToday(date)) return false;

            // Ne peut pas √©diter si le jour est d√©j√† valid√©
            if (isDayValidated(date)) return false;

            return true;
        }


        // --- GESTION DU STOCKAGE LOCAL ---

        // Cr√©e une cl√© de date unique (YYYY-MM-DD) pour le stockage
        function getDateKey(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // R√©cup√®re toutes les donn√©es depuis le localStorage
        function getData() {
            const data = localStorage.getItem('warriorTracker');
            return data ? JSON.parse(data) : { days: {}, stats: { bestStreak: 0 } };
        }

        // Sauvegarde les donn√©es dans le localStorage
        function saveData(data) {
            localStorage.setItem('warriorTracker', JSON.stringify(data));
        }

        // R√©cup√®re les donn√©es d'un jour sp√©cifique
        function getDayData(date) {
            const data = getData();
            const key = getDateKey(date);
            return data.days[key] || {};
        }

        // Met √† jour le statut (coch√©/d√©coch√©) d'une habitude pour aujourd'hui
        function setHabitStatus(habitId, checked) {
            if (!canEditDate(currentDate)) { // Bloque la modification si ce n'est pas aujourd'hui
                return;
            }
            const data = getData();
            const key = getDateKey(currentDate);
            if (!data.days[key]) data.days[key] = {}; // Cr√©e un objet pour le jour s'il n'existe pas
            data.days[key][habitId] = checked;
            saveData(data);
            updateUI(); // Met √† jour l'interface utilisateur
        }


        // --- CALCULS ET LOGIQUE M√âTIER ---

        // Calcule le score (en %) d'un jour donn√©
        function getDayScore(date) {
            const dayData = getDayData(date);
            const completed = habits.filter(h => dayData[h.id]).length;
            return Math.round((completed / habits.length) * 100);
        }

        // Calcule la s√©rie (streak) de jours cons√©cutifs avec un score >= 70%
        function getStreak() {
            let streak = 0;
            let date = new Date();
            date.setDate(date.getDate() - 1); // Commence par v√©rifier hier

            while (true) {
                const score = getDayScore(date);
                if (score >= 70) {
                    streak++;
                    date.setDate(date.getDate() - 1); // Passe au jour pr√©c√©dent
                } else {
                    break; // La s√©rie est rompue
                }
            }

            if (getDayScore(new Date()) >= 70) {
                streak++; // Ajoute aujourd'hui si le score est suffisant
            }
            return streak;
        }

        // Compte le nombre total de jours parfaits (100% des habitudes compl√©t√©es)
        function getPerfectDays() {
            const data = getData();
            let count = 0;
            for (const key in data.days) {
                const dayData = data.days[key];
                const completed = habits.filter(h => dayData[h.id]).length;
                if (completed === habits.length) count++;
            }
            return count;
        }

        // D√©termine le rang de l'utilisateur en fonction de son score moyen
        function getRank(score) {
            if (score >= 86) return { name: 'LEGEND', color: '#F5F5F0' };
            if (score >= 71) return { name: 'ELITE', color: '#D4D4CF' };
            if (score >= 51) return { name: 'WARRIOR', color: '#A3A39E' };
            if (score >= 31) return { name: 'SOLDIER', color: '#7A7A75' };
            return { name: 'RECRUIT', color: '#5A5A55' };
        }

        // Calcule la s√©rie pour une habitude sp√©cifique
        function getHabitStreak(habitId) {
            let streak = 0;
            let date = new Date();
            date.setDate(date.getDate() - 1); // Commence hier

            while (true) {
                const dayData = getDayData(date);
                if (dayData[habitId]) {
                    streak++;
                    date.setDate(date.getDate() - 1);
                } else {
                    break;
                }
            }
            if (getDayData(new Date())[habitId]) streak++; // Ajoute aujourd'hui
            return streak;
        }

        // Calcule le score moyen pour le mois en cours
        function getMonthScore() {
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            let totalScore = 0;
            let daysWithData = 0;
            for (let d = new Date(startOfMonth); d <= now; d.setDate(d.getDate() + 1)) {
                const dayData = getDayData(d);
                if (Object.keys(dayData).length > 0) {
                    totalScore += getDayScore(new Date(d));
                    daysWithData++;
                }
            }
            return daysWithData > 0 ? Math.round(totalScore / daysWithData) : 0;
        }

        // Calcule le nombre total d'habitudes compl√©t√©es ("victoires")
        function getTotalWins() {
            const data = getData();
            let wins = 0;
            for (const key in data.days) {
                const dayData = data.days[key];
                wins += habits.filter(h => dayData[h.id]).length;
            }
            return wins;
        }

        // Calcule le score moyen global sur tous les jours enregistr√©s
        function getAvgScore() {
            const data = getData();
            const days = Object.keys(data.days);
            if (days.length === 0) return 0;
            let total = 0;
            days.forEach(key => {
                const dayData = data.days[key];
                const completed = habits.filter(h => dayData[h.id]).length;
                total += (completed / habits.length) * 100;
            });
            return Math.round(total / days.length);
        }

        // R√©cup√®re la meilleure s√©rie enregistr√©e
        function getBestStreak() {
            const data = getData();
            return data.stats?.bestStreak || getStreak();
        }

        // --- MISE √Ä JOUR DE L'INTERFACE UTILISATEUR (UI) ---

        // Formate une date en cha√Æne de caract√®res (ex: "lun. 28 d√©c.")
        function formatDate(date) {
            const options = { weekday: 'short', day: 'numeric', month: 'short' };
            return date.toLocaleDateString('fr-FR', options);
        }

        // Change la date affich√©e (jour pr√©c√©dent/suivant)
        function changeDate(delta) {
            const newDate = new Date(currentDate);
            newDate.setDate(newDate.getDate() + delta);
            const today = new Date();
            today.setHours(23, 59, 59, 999);
            if (newDate > today) { // Emp√™che de naviguer dans le futur
                return;
            }
            currentDate = newDate;
            updateUI();
        }

        function getCustomHabitNames() {
            const data = getData();
            return data.customHabitNames || {};
        }

        function getHabitDisplayName(habit) {
            const customNames = getCustomHabitNames();
            return customNames[habit.id] || habit.name;
        }

        // G√©n√®re et affiche la liste des habitudes pour la date actuelle
        function renderHabits() {
            const container = document.getElementById('habitsList');
            const dayData = getDayData(currentDate);
            const locked = !canEditDate(currentDate); // Verrouille si ce n'est pas aujourd'hui
            container.innerHTML = habits.map(habit => {
                const checked = dayData[habit.id] || false;
                const streak = getHabitStreak(habit.id);
                const monthData = getHabitMonthProgress(habit.id);
                const displayName = getHabitDisplayName(habit);
                const escapedId = habit.id.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                const onclickAttr = locked ? '' : `onclick="toggleHabit('${escapedId}')"`;
                const streakText = locked ? 'üîí Verrouill√©' : `üî• S√©rie: ${streak} jours`;
                return `
                    <div class="habit-item ${locked ? 'locked' : ''}" ${onclickAttr}>
                        <div class="habit-checkbox ${checked ? 'checked' : ''} ${locked ? 'locked' : ''}"></div>
                        <div class="habit-info">
                            <div class="habit-name">${habit.icon} ${displayName}</div>
                            <div class="habit-streak">${streakText}</div>
                        </div>
                        <div class="habit-progress">
                            <div class="percent">${monthData}%</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Calcule le pourcentage de compl√©tion d'une habitude pour le mois en cours
        function getHabitMonthProgress(habitId) {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const dayOfMonth = now.getDate();

            let completed = 0;
            let totalDays = dayOfMonth; // Nombre de jours √©coul√©s ce mois

            // Parcourir chaque jour du mois jusqu'√† aujourd'hui
            for (let day = 1; day <= dayOfMonth; day++) {
                const d = new Date(year, month, day);
                const dayData = getDayData(d);
                if (dayData[habitId]) {
                    completed++;
                }
            }

            return totalDays > 0 ? Math.round((completed / totalDays) * 100) : 0;
        }

        // G√®re le clic sur une habitude pour la cocher/d√©cocher
        function toggleHabit(habitId) {
            const dayData = getDayData(currentDate);
            const newStatus = !dayData[habitId];
            setHabitStatus(habitId, newStatus);
            if (navigator.vibrate) { // Vibration pour le retour haptique
                navigator.vibrate(newStatus ? [30, 30, 30] : 20);
            }
            if (newStatus) {
                const completed = habits.filter(h => getDayData(currentDate)[h.id]).length;
                if (completed === habits.length) {
                    triggerConfetti(); // Lance des confettis si toutes les habitudes sont compl√©t√©es
                }
            }
        }

        // D√©clenche une animation de confettis
        function triggerConfetti() {
            const colors = ['#F5F5F0', '#D4D4CF', '#A3A39E'];
            const confettiCount = 50;
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.style.cssText = `
                    position: fixed; width: 10px; height: 10px;
                    background: ${colors[Math.floor(Math.random() * colors.length)]};
                    left: ${Math.random() * 100}vw; top: -10px;
                    border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
                    pointer-events: none; z-index: 9999;
                    animation: confettiFall ${2 + Math.random() * 2}s linear forwards;
                    animation-delay: ${Math.random() * 0.5}s;
                `;
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 4000);
            }
            if (navigator.vibrate) {
                navigator.vibrate([50, 50, 50, 50, 100]);
            }
        }

        // Met √† jour les KPIs (score, streak, etc.) sur la page "Aujourd'hui"
        function updateKPIs() {
            const dayData = getDayData(currentDate);
            const completed = habits.filter(h => dayData[h.id]).length;
            const score = getDayScore(currentDate);
            const locked = !canEditDate(currentDate);

            document.getElementById('dailyScore').textContent = score + '%';
            document.getElementById('currentStreak').textContent = getStreak();
            document.getElementById('perfectDays').textContent = getPerfectDays();
            document.getElementById('completedCount').textContent = locked ? 'üîí VERROUILL√â' : `${completed}/${habits.length}`;
            document.getElementById('currentDate').textContent = formatDate(currentDate) + (locked ? ' üîí' : '');

            // Met √† jour la meilleure s√©rie si la s√©rie actuelle est plus longue
            const data = getData();
            const currentStreak = getStreak();
            if (currentStreak > (data.stats?.bestStreak || 0)) {
                data.stats = data.stats || {};
                data.stats.bestStreak = currentStreak;
                saveData(data);
            }
        }

        // Met √† jour tous les √©l√©ments de la page "Stats"
        function updateStats() {
            const avgScore = getAvgScore();
            const rank = getRank(avgScore);

            document.getElementById('rankName').textContent = rank.name;
            document.getElementById('rankName').style.color = rank.color;
            document.getElementById('rankProgress').style.width = avgScore + '%';
            document.getElementById('monthScore').textContent = getMonthScore() + '%';
            document.getElementById('bestStreak').textContent = getBestStreak();
            document.getElementById('totalWins').textContent = getTotalWins();
            document.getElementById('avgScore').textContent = avgScore + '%';

            renderWeeklyGrid();
            renderCharts();
        }

        // G√©n√®re et affiche la grille des scores de la semaine
        function renderWeeklyGrid() {
            const container = document.getElementById('weeklyGrid');
            const today = new Date();
            const dayNames = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
            let html = '';
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const score = getDayScore(date);
                html += `
                    <div class="weekly-day ${i === 0 ? 'today' : ''} ${score === 100 ? 'perfect' : ''}">
                        <div class="day-name">${dayNames[date.getDay()]}</div>
                        <div class="day-score">${score}%</div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        // G√©n√®re et met √† jour les graphiques
        function renderCharts() {
            // Graphique de score hebdomadaire
            const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
            const weeklyData = [];
            const weeklyLabels = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                weeklyLabels.push(date.getDate() + '/' + (date.getMonth() + 1));
                weeklyData.push(getDayScore(date));
            }
            if (weeklyChart) weeklyChart.destroy();
            weeklyChart = new Chart(weeklyCtx, {
                type: 'line',
                data: {
                    labels: weeklyLabels,
                    datasets: [{
                        data: weeklyData,
                        borderColor: '#F5F5F0',
                        backgroundColor: 'rgba(245, 245, 240, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { min: 0, max: 100, ticks: { color: '#A3A39E' }, grid: { color: '#2D2D2D' } }, x: { ticks: { color: '#A3A39E' }, grid: { color: '#2D2D2D' } } }
                }
            });

            // Graphique de performance par habitude
            const habitsCtx = document.getElementById('habitsChart').getContext('2d');
            const habitsData = habits.map(h => getHabitMonthProgress(h.id));
            if (habitsChart) habitsChart.destroy();
            habitsChart = new Chart(habitsCtx, {
                type: 'bar',
                data: {
                    labels: habits.map(h => h.icon),
                    datasets: [{
                        data: habitsData,
                        backgroundColor: habitsData.map(v => v >= 80 ? '#F5F5F0' : v >= 50 ? '#A3A39E' : '#5A5A55'),
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { min: 0, max: 100, ticks: { color: '#A3A39E' }, grid: { color: '#2D2D2D' } }, x: { ticks: { color: '#F5F5F0', font: { size: 16 } }, grid: { display: false } } }
                }
            });
        }

                // G√®re l'affichage des diff√©rentes pages (Aujourd'hui, Stats, Motivation)

                function showPage(page, event) {

                    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));

                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

                    

                    const pageElement = document.getElementById('page-' + page);

                    if (pageElement) {

                        pageElement.classList.add('active');

                    }

        

                    if (event && event.currentTarget) {

                        event.currentTarget.classList.add('active');

                    }

        

        

                    if (page === 'stats') {

                        updateStats();

                    } else if (page === 'motivation') {

                        const quote = quotes[Math.floor(Math.random() * quotes.length)];

                        document.getElementById('dailyQuote').textContent = '"' + quote.text + '"';

                        document.getElementById('quoteAuthor').textContent = '- ' + quote.author;

                    }

                }

        

                // FONCTIONS BOUCHONS POUR LES FONCTIONNALIT√âS NON IMPLEMENT√âES

                function openManageHabitsModal() { alert('La gestion des habitudes est en cours de d√©veloppement.'); }

                function closeManageHabitsModal() { console.log("closeManageHabitsModal called"); }

                function toggleAddHabitForm() { alert('La gestion des habitudes est en cours de d√©veloppement.'); }

                function cancelAddHabit() { console.log("cancelAddHabit called"); }

                function saveNewHabit() { alert('La gestion des habitudes est en cours de d√©veloppement.'); }

                function renderHabitsManagementList() { console.log("renderHabitsManagementList called"); }

                function setupIconPicker() { console.log("setupIconPicker called"); }

                function setupColorPicker() { console.log("setupColorPicker called"); }

                function resetAddHabitForm() { console.log("resetAddHabitForm called"); }

                function updateHabitName(id) { alert('La gestion des habitudes est en cours de d√©veloppement.'); }

                function deleteHabit(id) { alert('La gestion des habitudes est en cours de d√©veloppement.'); }

                function moveHabit(id, dir) { alert('La gestion des habitudes est en cours de d√©veloppement.'); }

        

        // R√©initialise toutes les donn√©es de l'application apr√®s confirmation
        function resetAllData() {
            if (confirm('‚ö†Ô∏è Es-tu s√ªr de vouloir tout r√©initialiser ? Cette action est irr√©versible !')) {
                if (confirm('üî• DERNI√àRE CHANCE : Vraiment tout supprimer ?')) {
                    localStorage.removeItem('warriorTracker');
                    updateUI();
                    alert('‚úÖ Donn√©es r√©initialis√©es. Nouveau d√©part WARRIOR !');
                }
            }
        }

        // Fonction principale de mise √† jour de l'UI
        function updateUI() {
            renderHabits();
            updateKPIs();
            updateValidateButton();
        }

        // --- √âDITION DES HABITUDES ---

        // ============================================================
        // HABIT MANAGEMENT FUNCTIONS (Gestion dynamique des habitudes)
        // ============================================================

        // Variables globales pour la gestion des habitudes
        let selectedIcon = 'üéØ';
        let selectedColor = '#F5F5F0';

        // Ouvrir la modal de gestion des habitudes
        function openManageHabitsModal() {
            const modal = document.getElementById('manageHabitsModal');
            renderHabitsManagementList();
            modal.classList.add('active');

            // Reset formulaire d'ajout
            resetAddHabitForm();
        }

        // Fermer la modal de gestion
        function closeManageHabitsModal() {
            document.getElementById('manageHabitsModal').classList.remove('active');
            resetAddHabitForm();
            updateUI(); // Rafra√Æchir l'affichage principal
        }

        // Afficher/masquer le formulaire d'ajout
        function toggleAddHabitForm() {
            const section = document.getElementById('addHabitSection');
            const form = document.getElementById('addHabitForm');

            if (form.classList.contains('active')) {
                form.classList.remove('active');
                section.classList.add('collapsed');
            } else {
                form.classList.add('active');
                section.classList.remove('collapsed');
                setupIconPicker();
                setupColorPicker();
            }
        }

        // Configuration du s√©lecteur d'ic√¥nes
        function setupIconPicker() {
            const iconOptions = document.querySelectorAll('#iconPicker .icon-option');
            iconOptions.forEach(option => {
                option.addEventListener('click', function() {
                    iconOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedIcon = this.dataset.icon;
                });
            });

            // S√©lectionner la premi√®re ic√¥ne par d√©faut
            if (iconOptions.length > 0 && !document.querySelector('#iconPicker .icon-option.selected')) {
                iconOptions[0].classList.add('selected');
                selectedIcon = iconOptions[0].dataset.icon;
            }
        }

        // Configuration du s√©lecteur de couleurs
        function setupColorPicker() {
            const colorOptions = document.querySelectorAll('#colorPicker .color-option');
            colorOptions.forEach(option => {
                option.addEventListener('click', function() {
                    colorOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedColor = this.dataset.color;
                });
            });

            // S√©lectionner la premi√®re couleur par d√©faut
            if (colorOptions.length > 0 && !document.querySelector('#colorPicker .color-option.selected')) {
                colorOptions[0].classList.add('selected');
                selectedColor = colorOptions[0].dataset.color;
            }
        }

        // R√©initialiser le formulaire d'ajout
        function resetAddHabitForm() {
            const section = document.getElementById('addHabitSection');
            const form = document.getElementById('addHabitForm');

            form.classList.remove('active');
            section.classList.add('collapsed');
            document.getElementById('newHabitName').value = '';

            // Reset s√©lections
            document.querySelectorAll('#iconPicker .icon-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelectorAll('#colorPicker .color-option').forEach(opt => opt.classList.remove('selected'));

            selectedIcon = 'üéØ';
            selectedColor = '#F5F5F0';
        }

        // Annuler l'ajout d'une habitude
        function cancelAddHabit() {
            resetAddHabitForm();
        }

        // Sauvegarder une nouvelle habitude
        function saveNewHabit() {
            const name = document.getElementById('newHabitName').value.trim().toUpperCase();

            if (!name) {
                alert('‚ö†Ô∏è Le nom de l\'habitude est requis');
                return;
            }

            // G√©n√©rer un ID unique
            const habitId = 'habit_' + Date.now();

            // Ajouter l'habitude au tableau
            const newHabit = {
                id: habitId,
                name: name,
                icon: selectedIcon,
                color: selectedColor
            };

            habits.push(newHabit);

            // Sauvegarder dans localStorage (ou Firestore si configur√©)
            const data = getData();
            if (!data.customHabits) data.customHabits = [];
            data.customHabits.push(newHabit);
            saveData(data);

            // Feedback
            if (navigator.vibrate) navigator.vibrate([30, 30, 30]);
            alert(`‚úÖ Habitude "${name}" ajout√©e avec succ√®s !`);

            // Reset et refresh
            resetAddHabitForm();
            renderHabitsManagementList();
            updateUI();
        }

        // Afficher la liste des habitudes dans la modal
        function renderHabitsManagementList() {
            const container = document.getElementById('habitsManagementList');

            if (habits.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--accent-dim); padding: 20px;">Aucune habitude. Ajoute-en une !</p>';
                return;
            }

            container.innerHTML = habits.map((habit, index) => {
                const color = habit.color || '#F5F5F0';
                const disabledUp = index === 0 ? 'disabled' : '';
                const disabledDown = index === habits.length - 1 ? 'disabled' : '';
                const escapedName = (habit.name || '').replace(/"/g, '&quot;');
                const escapedId = habit.id.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                return `
                    <div class="habit-management-item" data-habit-id="${habit.id}">
                        <div class="move-buttons">
                            <button class="move-btn" onclick="moveHabit('${escapedId}', -1)" ${disabledUp}>‚ñ≤</button>
                            <button class="move-btn" onclick="moveHabit('${escapedId}', 1)" ${disabledDown}>‚ñº</button>
                        </div>
                        <div class="habit-color-indicator" style="background: ${color};"></div>
                        <div class="habit-icon-display">${habit.icon}</div>
                        <input type="text" class="habit-name-input" id="name-${habit.id}" value="${escapedName}" placeholder="Nom de l'habitude">
                        <div class="habit-actions">
                            <button class="habit-action-btn" onclick="updateHabitName('${escapedId}')">üíæ</button>
                            <button class="habit-action-btn delete" onclick="deleteHabit('${escapedId}')">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Mettre √† jour le nom d'une habitude
        function updateHabitName(habitId) {
            const input = document.getElementById(`name-${habitId}`);
            const newName = input.value.trim().toUpperCase();

            if (!newName) {
                alert('‚ö†Ô∏è Le nom ne peut pas √™tre vide');
                return;
            }

            // Trouver l'habitude
            const habit = habits.find(h => h.id === habitId);
            if (!habit) return;

            // Mettre √† jour le nom
            const originalName = habit.name;
            habit.name = newName;

            // Sauvegarder
            const data = getData();
            if (!data.customHabitNames) data.customHabitNames = {};

            // Si c'est une habitude par d√©faut
            const defaultHabit = [
                { id: 'coldshower', name: 'DOUCHE FROIDE' },
                { id: 'reading', name: 'LECTURE (30 min)' },
                { id: 'nutrition', name: 'NUTRITION CLEAN' },
                { id: 'sleep', name: 'SOMMEIL 8H+ (couch√© avant 22h)' },
                { id: 'hydration', name: 'HYDRATATION 2L+' },
                { id: 'wakeup', name: 'R√âVEIL 5H-6H' }
            ].find(h => h.id === habitId);

            if (defaultHabit) {
                data.customHabitNames[habitId] = newName;
            } else {
                // Habitude personnalis√©e
                if (!data.customHabits) data.customHabits = [];
                const customHabit = data.customHabits.find(h => h.id === habitId);
                if (customHabit) {
                    customHabit.name = newName;
                }
            }

            saveData(data);

            // Feedback
            if (navigator.vibrate) navigator.vibrate([30, 30, 30]);

            renderHabitsManagementList();
            updateUI();
        }

        // Supprimer une habitude
        function deleteHabit(habitId) {
            const habit = habits.find(h => h.id === habitId);
            if (!habit) return;

            if (!confirm(`üóëÔ∏è Supprimer "${habit.name}" ?\n\nL'historique sera conserv√© mais l'habitude n'appara√Ætra plus.`)) {
                return;
            }

            // Retirer du tableau
            const index = habits.findIndex(h => h.id === habitId);
            if (index > -1) {
                habits.splice(index, 1);
            }

            // Sauvegarder
            const data = getData();

            // Retirer des habitudes personnalis√©es
            if (data.customHabits) {
                data.customHabits = data.customHabits.filter(h => h.id !== habitId);
            }

            // Marquer comme supprim√©e (pour historique)
            if (!data.deletedHabits) data.deletedHabits = [];
            data.deletedHabits.push(habitId);

            saveData(data);

            // Feedback
            if (navigator.vibrate) navigator.vibrate(50);
            alert(`‚úÖ Habitude "${habit.name}" supprim√©e`);

            renderHabitsManagementList();
            updateUI();
        }

        // D√©placer une habitude (haut/bas)
        function moveHabit(habitId, direction) {
            const index = habits.findIndex(h => h.id === habitId);
            if (index === -1) return;

            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= habits.length) return;

            // Swap
            [habits[index], habits[newIndex]] = [habits[newIndex], habits[index]];

            // Sauvegarder l'ordre
            const data = getData();
            if (!data.habitOrder) data.habitOrder = [];
            data.habitOrder = habits.map(h => h.id);
            saveData(data);

            // Feedback
            if (navigator.vibrate) navigator.vibrate(20);

            renderHabitsManagementList();
            updateUI();
        }

        // Charger les habitudes personnalis√©es au d√©marrage
        function loadCustomHabits() {
            const data = getData();

            // Charger les noms personnalis√©s
            if (data.customHabitNames) {
                Object.entries(data.customHabitNames).forEach(([habitId, customName]) => {
                    const habit = habits.find(h => h.id === habitId);
                    if (habit) {
                        habit.name = customName;
                    }
                });
            }

            // Charger les habitudes personnalis√©es ajout√©es
            if (data.customHabits && data.customHabits.length > 0) {
                data.customHabits.forEach(customHabit => {
                    // V√©rifier qu'elle n'existe pas d√©j√†
                    if (!habits.find(h => h.id === customHabit.id)) {
                        // V√©rifier qu'elle n'a pas √©t√© supprim√©e
                        if (!data.deletedHabits || !data.deletedHabits.includes(customHabit.id)) {
                            habits.push(customHabit);
                        }
                    }
                });
            }

            // Restaurer l'ordre
            if (data.habitOrder && data.habitOrder.length > 0) {
                const orderedHabits = [];
                data.habitOrder.forEach(habitId => {
                    const habit = habits.find(h => h.id === habitId);
                    if (habit) {
                        orderedHabits.push(habit);
                    }
                });
                // Ajouter les habitudes qui ne sont pas dans l'ordre (nouvelles)
                habits.forEach(habit => {
                    if (!orderedHabits.find(h => h.id === habit.id)) {
                        orderedHabits.push(habit);
                    }
                });
                // Remplacer le tableau
                habits.length = 0;
                habits.push(...orderedHabits);
            }
        }

        // Fermer la modale si on clique en dehors
        document.getElementById('manageHabitsModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeManageHabitsModal();
            }
        });


        // --- GESTION DES NOTIFICATIONS ---

        // Demande la permission d'envoyer des notifications
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.log('Notifications non support√©es');
                return false;
            }
            if (Notification.permission === 'granted') return true;
            if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                return permission === 'granted';
            }
            return false;
        }

        // Programme une notification quotidienne √† l'heure configur√©e
        function scheduleNotification() {
            const data = getData();
            const notifTime = data.notificationTime || '21:00'; // Par d√©faut 21h

            // Parser l'heure (format "HH:MM")
            const [hours, minutes] = notifTime.split(':').map(Number);

            const now = new Date();
            const target = new Date();
            target.setHours(hours, minutes, 0, 0);

            if (now > target) { // Si l'heure est d√©j√† pass√©e, programmer pour demain
                target.setDate(target.getDate() + 1);
            }

            const delay = target.getTime() - now.getTime();
            setTimeout(() => {
                sendNotification();
                scheduleNotification(); // Reprogramme pour le jour suivant
            }, delay);

            console.log(`‚è∞ Notification programm√©e dans ${Math.round(delay / 60000)} minutes (${notifTime})`);
        }

        // Envoie la notification avec un message personnalis√©
        function sendNotification() {
            if (Notification.permission !== 'granted') return;
            const dayData = getDayData(new Date());
            const completed = habits.filter(h => dayData[h.id]).length;
            const remaining = habits.length - completed;
            let title, body;
            if (remaining === 0) {
                title = "üèÜ L√âGENDE !"; body = "Tu as compl√©t√© toutes tes habitudes. STAY HARD!";
            } else if (remaining <= 2) {
                title = "‚öîÔ∏è PRESQUE WARRIOR !"; body = `Plus que ${remaining} habitude${remaining > 1 ? 's' : ''} √† valider. Tu peux le faire !`;
            } else {
                title = "üî• RAPPEL WARRIOR"; body = `${remaining} habitudes restantes. Ne l√¢che rien !`;
            }
            const notification = new Notification(title, {
                body: body,
                icon: 'data:image/svg+xml,...', // (ic√¥ne SVG)
                tag: 'warrior-reminder',
                renotify: true
            });
            notification.onclick = () => { window.focus(); notification.close(); };

            // Afficher automatiquement le popup de validation
            setTimeout(() => {
                showValidateDayModal();
            }, 2000); // Attendre 2 secondes pour laisser l'utilisateur voir la notification
        }

        // Active ou d√©sactive les notifications via le bouton
        function toggleNotifications() {
            const data = getData();
            if (data.notificationsEnabled) {
                data.notificationsEnabled = false;
                saveData(data);
                alert('üîï Notifications d√©sactiv√©es');
            } else {
                requestNotificationPermission().then(granted => {
                    if (granted) {
                        data.notificationsEnabled = true;
                        saveData(data);
                        scheduleNotification();
                        const notifTime = data.notificationTime || '21:00';
                        alert(`üîî Notifications activ√©es ! Rappel √† ${notifTime}.`);
                    } else {
                        alert('‚ùå Permission refus√©e.');
                    }
                });
            }
            updateNotificationButton();
        }

        // Met √† jour le texte du bouton de notifications
        function updateNotificationButton() {
            const btn = document.getElementById('notifBtn');
            if (btn) {
                const data = getData();
                btn.textContent = data.notificationsEnabled ? 'üîî Notifications ON' : 'üîï Notifications OFF';
            }
        }

        // --- VALIDATION DE JOURN√âE ---

        // Met √† jour l'heure de notification personnalis√©e
        function updateNotificationTime() {
            const timeInput = document.getElementById('notifTime');
            if (!timeInput) return;

            const time = timeInput.value; // Format: "HH:MM"
            const data = getData();
            data.notificationTime = time;
            saveData(data);

            console.log(`‚è∞ Heure de notification mise √† jour: ${time}`);

            // Reprogrammer la notification si activ√©e
            if (data.notificationsEnabled) {
                scheduleNotification();
            }

            // Feedback visuel
            if (navigator.vibrate) navigator.vibrate(50);
        }

        // Affiche le modal de validation de journ√©e
        function showValidateDayModal() {
            const modal = document.getElementById('validateDayModal');
            if (modal) {
                modal.classList.add('active');
            }
        }

        // Ferme le modal de validation
        function closeValidateDayModal() {
            const modal = document.getElementById('validateDayModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // Confirme et valide la journ√©e en cours
        function confirmValidateDay() {
            const data = getData();
            const today = getDateKey(new Date());

            // Initialiser le tableau des jours valid√©s si n√©cessaire
            if (!data.validatedDays) {
                data.validatedDays = [];
            }

            // V√©rifier si d√©j√† valid√©
            if (data.validatedDays.includes(today)) {
                closeValidateDayModal();
                alert('‚úÖ Cette journ√©e est d√©j√† valid√©e !');
                return;
            }

            // Ajouter le jour aux jours valid√©s
            data.validatedDays.push(today);
            saveData(data);

            // Fermer le modal
            closeValidateDayModal();

            // Feedback
            if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 100]);
            alert('‚úÖ Journ√©e valid√©e ! Bravo WARRIOR ! üí™');

            // Confettis si jour parfait
            const dayData = getDayData(new Date());
            const completed = habits.filter(h => dayData[h.id]).length;
            if (completed === habits.length && habits.length > 0) {
                triggerConfetti();
            }

            // Masquer le bouton de validation et mettre √† jour l'UI
            updateValidateButton();
            renderHabits(); // Re-render pour verrouiller la journ√©e
        }

        // Met √† jour la visibilit√© du bouton de validation
        function updateValidateButton() {
            const btn = document.getElementById('validateDayBtn');
            if (!btn) return;

            const today = getDateKey(new Date());
            const currentDate = getDateKey(appState.currentDate);

            // Afficher uniquement si on visualise aujourd'hui
            if (currentDate !== today) {
                btn.style.display = 'none';
                return;
            }

            // V√©rifier si d√©j√† valid√©
            const data = getData();
            if (!data.validatedDays) data.validatedDays = [];

            if (data.validatedDays.includes(today)) {
                btn.style.display = 'none';
            } else {
                btn.style.display = 'block';
            }
        }

        // V√©rifie si un jour est valid√©
        function isDayValidated(date) {
            const data = getData();
            if (!data.validatedDays) return false;
            const dateKey = getDateKey(date);
            return data.validatedDays.includes(dateKey);
        }

        // Charge l'heure de notification configur√©e dans l'input
        function loadNotificationTime() {
            const notifTimeInput = document.getElementById('notifTime');
            if (!notifTimeInput) return;

            const data = getData();
            const savedTime = data.notificationTime || '21:00';
            notifTimeInput.value = savedTime;
        }

        // --- DIVERS ---

        // Affiche un message de bienvenue diff√©rent selon l'heure
        function getGreeting() {
            const hour = new Date().getHours();
            if (hour < 6) return "Debout t√¥t, GUERRIER !";
            if (hour < 12) return "Bonne matin√©e, WARRIOR !";
            if (hour < 18) return "Continue comme √ßa !";
            if (hour < 21) return "Finis en beaut√© !";
            return "Derni√®re ligne droite !";
        }


        // --- INITIALISATION DE L'APPLICATION ---
        document.addEventListener('DOMContentLoaded', () => {

            function initializeApp() {
                loadCustomHabits();
                updateUI();
                const savedData = getData();
                if (savedData.notificationsEnabled && Notification.permission === 'granted') {
                    scheduleNotification();
                }
                document.querySelector('.header .quote').textContent = `"${getGreeting()}" - STAY HARD`;
                updateNotificationButton();
                loadNotificationTime(); // Charger l'heure de notification configur√©e
            }

            function showAppPage(pageName) {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

                const pageElement = document.getElementById('page-' + pageName);
                if (pageElement) {
                    pageElement.classList.add('active');
                }
                const navItem = document.querySelector(`.nav-item[onclick*="'${pageName}'"]`);
                if (navItem) {
                    navItem.classList.add('active');
                }

                // Masquer header et navigation si on est sur la page auth
                const header = document.querySelector('.header');
                const bottomNav = document.querySelector('.bottom-nav');
                if (pageName === 'auth') {
                    if (header) header.style.display = 'none';
                    if (bottomNav) bottomNav.style.display = 'none';
                } else {
                    if (header) header.style.display = 'block';
                    if (bottomNav) bottomNav.style.display = 'flex';
                }
            }

            // G√©rer l'affichage initial
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));

            if (!isFirebaseConfigured) {
                console.log("Mode localStorage seul activ√©.");
                document.getElementById('logoutBtn').style.display = 'none';
                showAppPage('today');
                initializeApp();
            } else {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        appState.currentUser = user;
                        console.log('‚úÖ Utilisateur connect√©:', user.email);

                        // Mettre √† jour lastLogin
                        try {
                            await db.collection('users').doc(user.uid).update({
                                lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        } catch (error) {
                            console.warn('Erreur MAJ lastLogin:', error);
                        }

                        // V√©rifier s'il faut migrer les donn√©es localStorage
                        checkLocalStorageMigration(user);

                        document.getElementById('logoutBtn').style.display = 'block';
                        document.getElementById('deleteAccountBtn').style.display = 'block';
                        showAppPage('today');
                        initializeApp();
                    } else {
                        appState.currentUser = null;
                        console.log('‚ö†Ô∏è Utilisateur non connect√©');
                        document.getElementById('logoutBtn').style.display = 'none';
                        document.getElementById('deleteAccountBtn').style.display = 'none';
                        showAppPage('auth');
                    }
                });
            }

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch((err) => {
                    console.log('√âchec de l\'enregistrement du Service Worker:', err);
                });
            }
        });
    </script>
</body>

</html>